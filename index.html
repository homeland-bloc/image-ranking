<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <!-- PWA Configuration -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Peony">

    <!-- Favicon for browsers -->
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">

    <!-- Apple Touch Icon for iOS home screen -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">

    <!-- Android Chrome Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/favicon/android-chrome-512x512.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/favicon/site.webmanifest">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#C77BA6">

    <title>Peony</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mauve': {
                            300: '#D88FB8',
                            400: '#C77BA6',
                            500: '#B76E9E',
                            600: '#A86590',
                            700: '#995C82'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lilita+One&display=swap');
        
        @keyframes tickAppear {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .tick-animation {
            animation: tickAppear 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-overlay {
            animation: modalFadeIn 0.2s ease-out;
            background: rgba(0, 0, 0, 0.7);
        }
        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        .results-bg {
            background: linear-gradient(to bottom,
                rgba(250, 232, 255, 0.3),
                rgba(220, 252, 231, 0.3)
            );
        }
        body {
            background: linear-gradient(to bottom,
                rgba(252, 231, 243, 0.15),
                rgba(255, 255, 255, 1) 30%,
                rgba(220, 252, 231, 0.15)
            );
        }
        body.modal-open {
            overflow: hidden;
        }
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes toastSlideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes toastFadeOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-20px); opacity: 0; }
        }
        .toast-notification {
            animation: toastSlideIn 0.3s ease-out;
        }
        .toast-notification.fade-out {
            animation: toastFadeOut 0.3s ease-out;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-track {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, rgb(199, 123, 166) 0%, rgb(34, 197, 94) 100%);
        }
        input[type="range"]::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, rgb(199, 123, 166) 0%, rgb(34, 197, 94) 100%);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 2px solid rgb(199, 123, 166);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 2px solid rgb(199, 123, 166);
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .upload-area {
            border: 3px dashed #C77BA6;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #B76E9E;
            background: rgba(199, 123, 166, 0.05);
        }
        .upload-area.dragover {
            border-color: #22C55E;
            background: rgba(34, 197, 94, 0.1);
            transform: scale(1.02);
        }
        .score-text {
            font-family: 'Lilita One', cursive;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), -1px -1px 2px rgba(0,0,0,0.8), 1px -1px 2px rgba(0,0,0,0.8), -1px 1px 2px rgba(0,0,0,0.8);
        }
        .progress-segment {
            height: 8px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .progress-segment:hover {
            transform: scaleY(1.3);
        }
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-block;
        }
        .toggle-switch.active {
            background-color: #C77BA6;
        }
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        .voting-image {
            max-height: 50vh;
        }
        @media (min-width: 640px) {
            .voting-image {
                max-height: min(40vh, 500px);
            }
        }
        /* PWA safe area support for iOS and Android fullscreen mode */
        .safe-header {
            padding-top: env(safe-area-inset-top);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app"></div>

    <script>
        const ADMIN_DISCORD_ID = 'demo-user-123';  // Changed to match DemoUser for testing
        
        const mockUser = {
            id: 'demo-user-123',
            username: 'DemoUser',
            avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=demo'
        };

        // Consistent mock users for testing
        const mockUsers = [
            {
                id: 'demo-user-123',
                username: 'DemoUser',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=demo'
            },
            {
                id: 'user-nature-lover',
                username: 'NatureLover',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=nature'
            },
            {
                id: 'user-photo-pro',
                username: 'PhotoPro',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=photo'
            },
            {
                id: 'user-art-enthusiast',
                username: 'ArtEnthusiast',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=art'
            },
            {
                id: 'user-creative-mind',
                username: 'CreativeMind',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=creative'
            },
            {
                id: 'user-pixel-master',
                username: 'PixelMaster',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=pixel'
            },
            {
                id: 'user-lens-wizard',
                username: 'LensWizard',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=lens'
            },
            {
                id: 'user-visual-artist',
                username: 'VisualArtist',
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=visual'
            }
        ];

        const mockContests = [
            {
                id: 'contest-1',
                title: 'Spring Garden Photography',
                isLocked: false,
                resultsPublic: true,
                createdBy: 'demo-user-123',
                creatorName: 'DemoUser',
                creatorAvatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=demo',
                createdAt: Date.now() - 7 * 24 * 60 * 60 * 1000, // 7 days ago
                images: [
                    { id: 1, url: 'https://images.unsplash.com/photo-1490750967868-88aa4486c946?w=800', author: null, isFileUpload: false },
                    { id: 2, url: 'https://images.unsplash.com/photo-1464297162577-f5295c892194?w=800', author: null, isFileUpload: false },
                    { id: 3, url: 'https://images.unsplash.com/photo-1466781783364-36c955e42a7f?w=800', author: null, isFileUpload: false },
                    { id: 4, url: 'https://images.unsplash.com/photo-1455659817273-f96807779a8a?w=800', author: null, isFileUpload: false },
                    { id: 5, url: 'https://images.unsplash.com/photo-1463852247062-1bbca38f7805?w=800', author: null, isFileUpload: false }
                ]
            },
            {
                id: 'contest-2',
                title: 'Urban Architecture Challenge',
                isLocked: true,
                resultsPublic: false,
                createdBy: 'demo-user-123',
                creatorName: 'DemoUser',
                creatorAvatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=demo',
                createdAt: Date.now() - 3 * 24 * 60 * 60 * 1000, // 3 days ago
                images: [
                    { id: 6, url: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800', author: null, isFileUpload: false },
                    { id: 7, url: 'https://images.unsplash.com/photo-1480714378408-67cf0d13bc1b?w=800', author: null, isFileUpload: false },
                    { id: 8, url: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=800', author: null, isFileUpload: false }
                ]
            },
            {
                id: 'contest-3',
                title: 'Wildlife Photography Contest',
                isLocked: false,
                resultsPublic: true,
                createdBy: 'user-nature-lover',
                creatorName: 'NatureLover',
                creatorAvatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=nature',
                createdAt: Date.now() - 1 * 24 * 60 * 60 * 1000, // 1 day ago
                images: [
                    { id: 9, url: 'https://images.unsplash.com/photo-1564349683136-77e08dba1ef7?w=800', author: null, isFileUpload: false },
                    { id: 10, url: 'https://images.unsplash.com/photo-1437622368342-7a3d73a34c8f?w=800', author: null, isFileUpload: false },
                    { id: 11, url: 'https://images.unsplash.com/photo-1441057206919-63d19fac2369?w=800', author: null, isFileUpload: false },
                    { id: 12, url: 'https://images.unsplash.com/photo-1456926631375-92c8ce872def?w=800', author: null, isFileUpload: false }
                ]
            }
        ];

        let state = {
            isLoggedIn: false,
            user: null,
            view: 'home',
            contests: mockContests,
            currentContest: null,
            currentImageIndex: 0,
            votes: {},
            userVotedContests: {},
            hasSubmitted: false,
            showBreakdownModal: null,
            showTickAnimation: false,
            isAnimating: false,
            modal: null,
            modalProcessing: false,
            imageScale: 100,
            mockResults: null,
            mockResultsCache: {}, // Format: { contestId: generatedResults }
            scaleUpdateTimeout: null,
            newContest: { title: '', images: [], labelsEnabled: false },
            showMyVotes: false,  // Deprecated, use resultsView
            resultsView: 'average',  // 'average', 'myVotes', or 'byVoter'
            shuffledImages: [],
            nextContestId: 4, // Start at 4 since we have 3 mock contests
            bannedUsers: [], // Array of user IDs who are banned from app
            allUsers: [...mockUsers], // Track all users who have logged in - initialized with mock users
            showUserList: false, // Show user list modal (admin only)
            showAdminDashboard: false, // Show admin dashboard modal
            showJoinModal: false, // Show join contests modal
            joinedContests: [], // Array of contest IDs joined with current contest
            mergedContestMap: [], // Map of contest numbers to titles for merged view
            filters: {
                createdBy: null,           // Username or null
                sortBy: 'newest'           // 'newest', 'oldest', 'mostVoted', 'leastVoted'
            },
            toast: null // Toast notification { message, icon }
        };


        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function getScoreColor(score) {
            const colors = {
                1: 'rgb(220, 38, 38)',
                2: 'rgb(249, 115, 22)',
                3: 'rgb(234, 179, 8)',
                4: 'rgb(132, 204, 22)',
                5: 'rgb(34, 197, 94)'
            };
            return colors[score] || 'rgb(156, 163, 175)';
        }

        function getCategoryLabel(min, max) {
            if (min === 4.5) return '4.5 - 5.0';
            return `${min.toFixed(1)} - ${max.toFixed(2)}`;
        }

        function getCategoryColor(min) {
            // Bright green with cyan/blue undertone for top scores
            if (min >= 4.5) return { color: 'text-emerald-700', bg: 'bg-emerald-100', textColor: 'rgb(16, 185, 129)', bgColor: 'rgb(209, 250, 229)' };
            // Lime green
            if (min >= 4.0) return { color: 'text-lime-600', bg: 'bg-lime-50', textColor: 'rgb(77, 124, 15)', bgColor: 'rgb(236, 252, 203)' };
            // Yellow-green blend
            if (min >= 3.5) return { color: 'text-lime-500', bg: 'bg-lime-100', textColor: 'rgb(163, 230, 53)', bgColor: 'rgb(220, 252, 231)' };
            // Yellow
            if (min >= 3.0) return { color: 'text-yellow-600', bg: 'bg-yellow-100', textColor: 'rgb(202, 138, 4)', bgColor: 'rgb(254, 240, 138)' };
            // Orange-yellow blend
            if (min >= 2.5) return { color: 'text-orange-500', bg: 'bg-orange-200', textColor: 'rgb(251, 146, 60)', bgColor: 'rgb(254, 215, 170)' };
            // Orange
            if (min >= 2.0) return { color: 'text-orange-600', bg: 'bg-orange-100', textColor: 'rgb(234, 88, 12)', bgColor: 'rgb(255, 237, 213)' };
            // Red-orange blend
            if (min >= 1.5) return { color: 'text-red-500', bg: 'bg-red-100', textColor: 'rgb(239, 68, 68)', bgColor: 'rgb(254, 226, 226)' };
            // Red
            if (min >= 1.0) return { color: 'text-red-600', bg: 'bg-red-200', textColor: 'rgb(220, 38, 38)', bgColor: 'rgb(254, 202, 202)' };
            // Dark red
            if (min >= 0.5) return { color: 'text-red-700', bg: 'bg-red-300', textColor: 'rgb(185, 28, 28)', bgColor: 'rgb(252, 165, 165)' };
            // Darkest red
            return { color: 'text-red-800', bg: 'bg-red-400', textColor: 'rgb(153, 27, 27)', bgColor: 'rgb(248, 113, 113)' };
        }

        // Seeded random number generator for consistent demo voters
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function generateFixedDemoVoters(contestId, imageId) {
            // Use mockUsers for consistent demo voters (skip first user which is DemoUser/admin)
            const demoVoters = mockUsers.slice(1).map((user, index) => ({
                ...user,
                seed: index + 1
            }));

            // Extract numeric part from contestId (e.g., "contest-1" -> 1)
            const contestNum = typeof contestId === 'string'
                ? parseInt(contestId.split('-').pop()) || 0
                : contestId;

            // Convert imageId to number (handle both string and numeric IDs)
            const imageNum = typeof imageId === 'string'
                ? parseInt(imageId) || 0
                : imageId;

            // Generate consistent number of voters (3-6) based on contest
            const voterCountSeed = contestNum * 100;
            const voterCount = 3 + Math.floor(seededRandom(voterCountSeed) * 4); // 3-6 voters

            return demoVoters.slice(0, voterCount).map(voter => {
                // Generate consistent score (1-5) based on contest + image + voter
                const scoreSeed = contestNum * 1000 + (imageNum % 1000) * 100 + voter.seed;
                const score = 1 + Math.floor(seededRandom(scoreSeed) * 5); // 1-5

                return {
                    username: voter.username,
                    avatar: voter.avatar,
                    score: score,
                    isCurrentUser: false,
                    userId: voter.id
                };
            });
        }

        function generateMockResults(contest, userVotes) {
            // Check cache first
            const cacheKey = contest.id;
            if (state.mockResultsCache[cacheKey]) {
                return state.mockResultsCache[cacheKey];
            }

            // Generate fixed demo voters for consistency
            const hasVoted = Object.keys(userVotes).length > 0;
            const demoVoters = generateFixedDemoVoters(contest.id, 0); // Same demo voters for all images in contest

            const results = contest.images.map(img => {
                // Get fixed scores for this specific image
                const imageVoters = generateFixedDemoVoters(contest.id, img.id);

                let breakdown = hasVoted ? [
                    {
                        username: state.user.username,
                        avatar: state.user.avatar,
                        score: userVotes[img.id] || 3,
                        isCurrentUser: true,
                        userId: state.user.id
                    },
                    ...imageVoters
                ] : imageVoters;

                // Mark banned users
                breakdown = breakdown.map(vote => {
                    const isBanned = state.bannedUsers.includes(vote.userId);
                    return { ...vote, isBanned };
                });

                // Calculate average excluding banned votes
                const validVotes = breakdown.filter(vote => !vote.isBanned);
                const sum = validVotes.reduce((acc, vote) => acc + vote.score, 0);
                const averageScore = validVotes.length > 0 ? parseFloat((sum / validVotes.length).toFixed(2)) : 0;

                return {
                    ...img,
                    averageScore,
                    totalVotes: validVotes.length,
                    breakdown
                };
            }).sort((a, b) => b.averageScore - a.averageScore);

            // Cache results
            state.mockResultsCache[cacheKey] = results;

            return results;
        }

        function groupByScoreRange(results) {
            const ranges = [
                { min: 4.5, max: 5.0 },
                { min: 4.0, max: 4.49 },
                { min: 3.5, max: 3.99 },
                { min: 3.0, max: 3.49 },
                { min: 2.5, max: 2.99 },
                { min: 2.0, max: 2.49 },
                { min: 1.5, max: 1.99 },
                { min: 1.0, max: 1.49 },
                { min: 0.5, max: 0.99 },
                { min: 0.0, max: 0.49 }
            ];
            
            const grouped = {};
            
            ranges.forEach(range => {
                const key = `${range.min}-${range.max}`;
                const items = results.filter(r => r.averageScore >= range.min && r.averageScore <= range.max);
                if (items.length > 0) {
                    grouped[key] = {
                        items: items.sort((a, b) => b.averageScore - a.averageScore),
                        min: range.min,
                        max: range.max
                    };
                }
            });
            
            return grouped;
        }

        function groupMyVotesByScore(results) {
            const grouped = {};

            [5, 4, 3, 2, 1].forEach(score => {
                const items = results.filter(r => r.averageScore === score);
                if (items.length > 0) {
                    grouped[score] = {
                        items: items,
                        score: score
                    };
                }
            });

            return grouped;
        }

        function getVoterCount(contest) {
            // Get cached results for this contest
            const results = state.mockResultsCache[contest.id];
            if (!results || !results[0]) return 0;

            // Get breakdown from first image (all images have same voters)
            return results[0].breakdown.length;
        }

        /**
         * Generate voter statistics across one or more contests
         * Calculates each voter's average score across all images they voted on
         *
         * @param {Object|Array} contests - Single contest object or array of contests for merged view
         * @returns {Array} Array of voter objects with calculated averages, sorted by average score (highest first)
         */
        function generateVoterStats(contests) {
            // Normalize input to array for consistent processing
            const contestList = Array.isArray(contests) ? contests : [contests];

            // Accumulator for voter data across all contests
            // Structure: { userId: { votes: [], totalScore: 0, totalImages: 0, username, avatar, etc. } }
            const voterVotes = {};

            contestList.forEach(contest => {
                // Generate mock results for this contest if not cached
                const userVotes = contest.id === state.currentContest.id ? state.votes : (state.userVotedContests[contest.id] || {});
                const results = state.mockResultsCache[contest.id] || generateMockResults(contest, userVotes);

                // Collect votes from all images
                results.forEach(imageResult => {
                    if (!imageResult.breakdown) return;

                    imageResult.breakdown.forEach(vote => {
                        if (vote.isBanned) return; // Skip banned users

                        if (!voterVotes[vote.userId]) {
                            voterVotes[vote.userId] = {
                                userId: vote.userId,
                                username: vote.username,
                                avatar: vote.avatar,
                                isCurrentUser: vote.isCurrentUser || false,
                                votes: [],
                                totalScore: 0,
                                totalImages: 0
                            };
                        }

                        voterVotes[vote.userId].votes.push(vote.score);
                        voterVotes[vote.userId].totalScore += vote.score;
                        voterVotes[vote.userId].totalImages++;
                    });
                });
            });

            // Calculate averages and sort by average score (highest to lowest)
            return Object.values(voterVotes)
                .map(voter => ({
                    ...voter,
                    averageScore: voter.totalImages > 0
                        ? parseFloat((voter.totalScore / voter.totalImages).toFixed(2))
                        : 0
                }))
                .sort((a, b) => b.averageScore - a.averageScore);
        }

        function showModal(config) {
            if (state.modalProcessing) return;
            state.modal = config;
            document.body.classList.add('modal-open');
            render();
        }

        function closeModal() {
            if (state.modalProcessing) return;
            state.modal = null;
            state.modalProcessing = false;
            document.body.classList.remove('modal-open');
            render();
        }

        function showAlert(message, icon = 'ðŸš¨') {
            showModal({
                type: 'alert',
                icon,
                message,
                buttons: [{ text: 'OK', action: 'closeModal', primary: true }]
            });
        }

        function showConfirm(message, onConfirmName, icon = 'ðŸš¨') {
            showModal({
                type: 'confirm',
                icon,
                message,
                buttons: [
                    { text: 'Cancel', action: 'closeModal', primary: false },
                    { text: 'Confirm', action: onConfirmName, primary: true }
                ]
            });
        }

        function showToast(message, icon = 'âœ…') {
            state.toast = { message, icon };
            render();

            // Auto-dismiss after 2.5 seconds
            setTimeout(() => {
                const toastEl = document.querySelector('.toast-notification');
                if (toastEl) {
                    toastEl.classList.add('fade-out');
                }
                setTimeout(() => {
                    state.toast = null;
                    render();
                }, 300);
            }, 2500);
        }

        function showInputModal(title, placeholder, onConfirmAction, allowEmpty = false) {
            showModal({
                type: 'input',
                icon: 'âœï¸',
                title,
                placeholder,
                allowEmpty,
                buttons: [
                    { text: 'Cancel', action: 'closeModal', primary: false },
                    { text: 'Continue', action: onConfirmAction, primary: true }
                ]
            });
        }

        function confirmSubmitVotes() {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.hasSubmitted = true;
            state.userVotedContests[state.currentContest.id] = {...state.votes};
            // Clear cache to ensure user's votes are included in results
            delete state.mockResultsCache[state.currentContest.id];
            state.joinedContests = []; // Clear merged contests when viewing single contest results
            state.view = 'results';
            state.mockResults = generateMockResults(state.currentContest, state.votes);
            state.modalProcessing = false;
            render();
        }

        function confirmCancelVoting() {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.view = 'home';
            state.currentContest = null;
            state.modalProcessing = false;
            render();
        }

        function canDeleteContest(contest) {
            return state.user && contest.createdBy === state.user.id;
        }

        function deleteContest(contestId) {
            showConfirm(
                'This will permanently delete the contest and all its data. This action cannot be undone.',
                `confirmDeleteContest_${contestId}`,
                'ðŸ—‘ï¸'
            );
        }

        function confirmDeleteContest(contestId) {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            
            const contest = state.contests.find(c => c.id === contestId);
            const hasFileUploads = contest && contest.images.some(img => img.isFileUpload);
            
            if (hasFileUploads) {
                console.log('Would delete uploaded files from storage');
            }
            
            state.contests = state.contests.filter(c => c.id !== contestId);
            delete state.userVotedContests[contestId];
            
            state.modalProcessing = false;
            showAlert('Contest deleted successfully!', 'âœ…');
        }

        function startCreateContest() {
            showInputModal('Contest Title', 'Enter contest title...', 'handleContestTitle', false);
        }

        function handleContestTitle() {
            if (state.modalProcessing) return;
            const input = document.querySelector('.modal-input');
            const title = input ? input.value.trim() : '';

            if (!title || title.length === 0) {
                showAlert('Contest title cannot be empty.', 'âŒ');
                return;
            }
            if (title.length > 100) {
                showAlert('Contest title is too long (max 100 characters).', 'âŒ');
                return;
            }

            // Check for duplicate title
            const existingContest = state.contests.find(c => c.title.toLowerCase() === title.toLowerCase());
            if (existingContest) {
                showConfirm(
                    'A contest with this title already exists. Create anyway?',
                    'confirmCreateWithDuplicateTitle',
                    'ðŸš¨'
                );
                // Store the title temporarily for the confirmation
                state.tempContestTitle = title;
                return;
            }

            state.modalProcessing = true;
            state.newContest.title = title;
            state.newContest.images = [];
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.view = 'createContest';
            state.modalProcessing = false;
            render();
        }

        function confirmCreateWithDuplicateTitle() {
            state.modalProcessing = true;
            const title = state.tempContestTitle;
            state.tempContestTitle = null;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.newContest.title = title;
            state.newContest.images = [];
            state.view = 'createContest';
            state.modalProcessing = false;
            render();
        }

        function cancelCreateContest() {
            showConfirm(
                'Your progress will be lost if you proceed. Are you sure?',
                'confirmCancelCreate',
                'ðŸš¨'
            );
        }

        function confirmCancelCreate() {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.view = 'home';
            state.newContest = { title: '', images: [] };
            state.modalProcessing = false;
            render();
        }

        async function addImageFromUrl(urlInputId) {
            const input = document.getElementById(urlInputId);
            let url = input.value.trim();

            if (!url) {
                showAlert('Please enter an image URL!', 'âŒ');
                return;
            }

            // Convert Discord CDN URLs to media.discordapp.net for compatibility
            url = url.replace(/cdn\.discordapp\.com/g, 'media.discordapp.net');
            url = url.replace(/images-ext-\d+\.discordapp\.net/g, 'media.discordapp.net');

            if (state.newContest.images.length >= 50) {
                showAlert('Maximum 50 images per contest!', 'âŒ');
                return;
            }

            try {
                const img = await loadImageFromUrl(url);
                const imageCount = state.newContest.images.length + 1;
                state.newContest.images.push({
                    id: Date.now() + Math.random(),
                    url,
                    author: null,
                    isFileUpload: false,
                    label: `${imageCount}`
                });
                input.value = '';
                showToast('Image added successfully!', 'âœ…');
            } catch (error) {
                showAlert(`Failed to load image: ${error.message}`, 'âŒ');
            }
        }



        function removeContestImage(index) {
            showConfirm(
                'Delete this image from the contest?',
                `confirmRemoveImage_${index}`,
                'ðŸš¨'
            );
        }

        function confirmRemoveImage(index) {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.newContest.images.splice(index, 1);
            state.modalProcessing = false;
            render();
        }

        function toggleImageLabels() {
            state.newContest.labelsEnabled = !state.newContest.labelsEnabled;
            render();
        }

        function updateImageLabel(index, label) {
            if (state.newContest.images[index]) {
                // Convert Discord CDN URLs to media.discordapp.net for compatibility
                label = label.replace(/cdn\.discordapp\.com/g, 'media.discordapp.net');
                label = label.replace(/images-ext-\d+\.discordapp\.net/g, 'media.discordapp.net');
                state.newContest.images[index].label = label;
            }
        }

        function finishCreateContest() {
            if (state.newContest.images.length === 0) {
                showAlert('Add at least one image!', 'âŒ');
                return;
            }
            
            const newContest = {
                id: 'contest-' + state.nextContestId,
                title: state.newContest.title,
                isLocked: false,
                resultsPublic: true,
                createdBy: state.user.id,
                creatorName: state.user.username,
                creatorAvatar: state.user.avatar,
                createdAt: Date.now(),
                labelsEnabled: state.newContest.labelsEnabled,
                images: state.newContest.images
            };

            state.contests.unshift(newContest);
            state.nextContestId++;
            state.newContest = { title: '', images: [], labelsEnabled: false };
            state.view = 'home';
            showAlert('Contest created successfully!', 'âœ…');
        }

        async function loadImageFromUrl(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                let timedOut = false;

                // Network timeout with specific message
                const timeoutId = setTimeout(() => {
                    timedOut = true;
                    reject(new Error('â±ï¸ Network timeout: Image took too long to load. Possible causes: slow connection, large file size, or server issues. Try a different image or check your internet connection.'));
                }, 10000);

                img.onload = () => {
                    if (!timedOut) {
                        clearTimeout(timeoutId);
                        resolve(img);
                    }
                };

                img.onerror = () => {
                    if (timedOut) return; // Already handled by timeout
                    clearTimeout(timeoutId);

                    // Provide specific error details
                    let errorMsg = 'âŒ Failed to load image.\n\n';

                    // Check URL validity
                    try {
                        new URL(url);
                    } catch {
                        reject(new Error(errorMsg + 'ðŸ”— Invalid URL format. Please enter a valid image URL.'));
                        return;
                    }

                    // Check file extension
                    const extension = url.split('?')[0].split('.').pop().toLowerCase();
                    const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];

                    // Provide likely causes based on URL analysis
                    if (url.includes('discord')) {
                        errorMsg += 'ðŸ’¬ Discord CDN issue: The link may be expired, deleted, or have restricted access. Try re-uploading the image to Discord and getting a fresh link.';
                    } else if (url.startsWith('http://')) {
                        errorMsg += 'ðŸ”’ CORS/Security issue: HTTP URLs often have cross-origin restrictions. Try using an HTTPS URL instead, or upload the image to a public image host.';
                    } else if (!validExtensions.includes(extension)) {
                        errorMsg += 'ðŸ“ Unsupported format: The URL doesn\'t end with a recognized image extension (.jpg, .png, .gif, .webp). Make sure you\'re linking directly to an image file.';
                    } else if (url.includes('imgur') && !url.includes('i.imgur')) {
                        errorMsg += 'ðŸ–¼ï¸ Imgur link issue: Use direct image links (i.imgur.com) instead of gallery links. Right-click the image and select "Copy image address".';
                    } else {
                        errorMsg += 'ðŸŒ Possible causes:\nâ€¢ CORS restrictions from the image host\nâ€¢ Broken or expired link\nâ€¢ Image was deleted or moved\nâ€¢ Server is down or blocking requests\nâ€¢ Private/restricted access image\n\nTry uploading to a public image host like Imgur or Discord.';
                    }

                    reject(new Error(errorMsg));
                };

                img.src = url;
            });
        }

        function login() {
            state.isLoggedIn = true;
            state.user = mockUser;

            // Track user in allUsers if not already there
            if (!state.allUsers.find(u => u.id === mockUser.id)) {
                state.allUsers.push({
                    id: mockUser.id,
                    username: mockUser.username,
                    avatar: mockUser.avatar
                });
            }

            render();
        }

        function logout() {
            state.isLoggedIn = false;
            state.user = null;
            state.view = 'home';
            render();
        }


        function startVoting(contest) {
            state.currentContest = contest;
            state.shuffledImages = shuffleArray(contest.images);
            state.votes = {};
            state.currentImageIndex = 0;
            state.hasSubmitted = false;
            state.mockResults = null;
            state.view = 'vote';
            render();
        }

        function viewResults(contest) {
            state.currentContest = contest;
            const userVotes = state.userVotedContests[contest.id] || {};
            state.votes = userVotes;
            state.mockResults = generateMockResults(contest, userVotes);
            state.showMyVotes = false;
            state.joinedContests = []; // Clear merged contests when viewing single contest
            state.view = 'results';
            render();
        }

        function viewLockedResults(contest) {
            state.currentContest = contest;
            state.votes = {};
            state.mockResults = generateMockResults(contest, {});
            state.showMyVotes = false;
            state.joinedContests = []; // Clear merged contests when viewing single contest
            state.view = 'results';
            render();
        }

        function toggleContestLock(contestId) {
            const contest = state.contests.find(c => c.id === contestId);
            if (!contest) return;

            // Only the creator can lock/unlock
            if (contest.createdBy !== state.user.id) {
                showAlert('Only the creator can lock/unlock this contest.', 'ðŸ”’');
                return;
            }

            contest.isLocked = !contest.isLocked;
            showAlert(contest.isLocked ? 'ðŸ”’ Contest locked - Users cannot vote' : 'ðŸ”“ Contest unlocked - Users can now vote', contest.isLocked ? 'ðŸš¨' : 'âœ…');
            render();
        }

        function handleVote(score) {
            if (state.isAnimating) return;
            
            state.isAnimating = true;
            const currentImage = state.shuffledImages[state.currentImageIndex];
            state.votes[currentImage.id] = score;
            state.showTickAnimation = true;
            
            render();

            setTimeout(() => {
                state.showTickAnimation = false;
                state.isAnimating = false;
                if (state.currentImageIndex < state.shuffledImages.length - 1) {
                    state.currentImageIndex++;
                }
                render();
            }, 500);
        }

        function navigateImage(direction) {
            if (direction === 'next') {
                if (state.currentImageIndex < state.shuffledImages.length - 1) {
                    state.currentImageIndex++;
                }
            } else if (direction === 'prev' && state.currentImageIndex > 0) {
                state.currentImageIndex--;
            }
            render();
        }

        function jumpToImage(index) {
            if (state.isAnimating) return;
            state.currentImageIndex = index;
            render();
        }

        function cancelVoting() {
            showConfirm(
                'Your progress will be lost if you proceed. Are you sure?',
                'confirmCancelVoting',
                'ðŸš¨'
            );
        }

        function submitVotes() {
            const allVoted = state.shuffledImages.every(img => state.votes[img.id]);
            if (!allVoted) {
                showAlert('Please vote on all images before submitting!', 'âŒ');
                return;
            }
            showConfirm(
                'Your votes will be locked and cannot be changed after submission.',
                'confirmSubmitVotes',
                'ðŸ—³ï¸'
            );
        }

        function showBreakdown(imageId) {
            state.showBreakdownModal = imageId;
            document.body.classList.add('modal-open');
            render();
        }

        function showVoterVotes(username) {
            // Set viewing specific user
            state.viewingSpecificUser = username;
            state.showMyVotes = false;
            state.showVoterBreakdown = false;

            // Filter mockResults to show only images with this user's votes
            // and update the results to show this user's score as the primary score
            state.mockResults = state.mockResults.map(img => {
                const vote = img.breakdown.find(v => v.username === username);
                if (vote) {
                    return {
                        ...img,
                        averageScore: vote.score,
                        userSpecificScore: vote.score
                    };
                }
                return null;
            }).filter(img => img !== null)
            .sort((a, b) => b.averageScore - a.averageScore);

            render();
        }

        function viewUserVotes(username) {
            // Alias for showVoterVotes for clarity
            showVoterVotes(username);
        }

        function clearUserVotesView() {
            state.viewingSpecificUser = null;
            state.showVoterBreakdown = true;
            // Regenerate full results
            if (state.currentContest) {
                const userVotes = state.userVotedContests[state.currentContest.id] || state.votes || {};
                state.mockResults = generateMockResults(state.currentContest, userVotes);
            }
            render();
        }

        function closeBreakdown() {
            state.showBreakdownModal = null;
            document.body.classList.remove('modal-open');
            render();
        }


        function backToHome() {
            if (state.view === 'vote' && !state.hasSubmitted) {
                showConfirm(
                    'Your progress will be lost if you proceed. Are you sure?',
                    'confirmBackToHome',
                    'ðŸš¨'
                );
                return;
            }
            state.view = 'home';
            state.currentContest = null;
            state.showBreakdownModal = null;
            state.mockResults = null;
            state.showMyVotes = false;
            render();
        }

        function confirmBackToHome() {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            state.view = 'home';
            state.currentContest = null;
            state.showBreakdownModal = null;
            state.mockResults = null;
            state.showMyVotes = false;
            state.modalProcessing = false;
            render();
        }

        function toggleVoteView() {
            state.showMyVotes = !state.showMyVotes;
            render();
        }

        function setResultsView(view) {
            state.resultsView = view;
            state.showMyVotes = view === 'myVotes';  // Backwards compatibility
            render();
        }

        function updateScale(value) {
            clearTimeout(state.scaleUpdateTimeout);
            state.scaleUpdateTimeout = setTimeout(() => {
                state.imageScale = parseInt(value);
                render();
            }, 200);
        }

        function adjustScale(delta) {
            const newScale = Math.max(40, Math.min(200, state.imageScale + delta));
            state.imageScale = newScale;
            render();
        }

        function showAdminDashboard() {
            state.showAdminDashboard = true;
            document.body.classList.add('modal-open');
            render();
        }

        function closeAdminDashboard() {
            state.showAdminDashboard = false;
            document.body.classList.remove('modal-open');
            render();
        }


        function viewAllByCreator(userId) {
            state.filters.createdBy = userId;
            state.view = 'home';
            render();
        }

        function banUser(userId) {
            if (!state.bannedUsers.includes(userId)) {
                state.bannedUsers.push(userId);
            }
            showAlert('User has been banned.', 'âœ…');
            render();
        }

        function unbanUser(userId) {
            state.bannedUsers = state.bannedUsers.filter(id => id !== userId);
            showAlert('User has been unbanned.', 'âœ…');
            render();
        }

        function confirmBanUser(userId) {
            showConfirm(
                'This user will not be able to create contests or vote. This action can be undone later.',
                `executeBanUser_${userId}`,
                'ðŸš«'
            );
        }

        function executeBanUser(userId) {
            state.modalProcessing = true;
            state.modal = null;
            document.body.classList.remove('modal-open');
            banUser(userId);
            state.modalProcessing = false;
        }

        function showJoinContests() {
            state.showJoinModal = true;
            document.body.classList.add('modal-open');
            render();
        }

        function closeJoinContests() {
            state.showJoinModal = false;
            state.joinedContests = [];
            document.body.classList.remove('modal-open');
            render();
        }

        function toggleJoinContest(contestId) {
            if (state.joinedContests.includes(contestId)) {
                state.joinedContests = state.joinedContests.filter(id => id !== contestId);
            } else {
                state.joinedContests.push(contestId);
            }
            render();
        }

        function applyJoinedContests() {
            if (state.joinedContests.length === 0) return;

            state.showJoinModal = false;
            document.body.classList.remove('modal-open');

            // Generate merged results
            state.mockResults = generateMergedResults();
            render();
        }

        function clearJoinedContests() {
            state.joinedContests = [];
            state.mockResults = generateMockResults(state.currentContest, state.votes);
            render();
        }

        function generateMergedResults() {
            // Create contest numbering map
            const allContests = [state.currentContest, ...state.joinedContests.map(id => state.contests.find(c => c.id === id)).filter(Boolean)];
            const contestNumberMap = {};
            allContests.forEach((contest, index) => {
                contestNumberMap[contest.id] = index + 1;
            });

            // Store the contest map for display in results
            state.mergedContestMap = allContests.map((contest, index) => ({
                number: index + 1,
                title: contest.title,
                id: contest.id
            }));

            // Get results from current contest
            const currentResults = generateMockResults(state.currentContest, state.votes).map(img => ({
                ...img,
                contestId: state.currentContest.id,
                contestTitle: state.currentContest.title,
                contestNumber: contestNumberMap[state.currentContest.id]
            }));

            // Get results from joined contests
            const joinedResults = state.joinedContests.flatMap(contestId => {
                const contest = state.contests.find(c => c.id === contestId);
                if (!contest) return [];

                const userVotes = state.userVotedContests[contestId] || {};
                return generateMockResults(contest, userVotes).map(img => ({
                    ...img,
                    contestId: contest.id,
                    contestTitle: contest.title,
                    contestNumber: contestNumberMap[contest.id]
                }));
            });

            // Combine and sort by average score
            return [...currentResults, ...joinedResults].sort((a, b) => b.averageScore - a.averageScore);
        }



        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (state.showBreakdownModal) {
                    closeBreakdown();
                } else if (state.modal) {
                    closeModal();
                }
            }
        });

        function renderToast() {
            if (!state.toast) return '';

            return `
                <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[70] toast-notification">
                    <div class="bg-white rounded-lg shadow-2xl px-6 py-3 flex items-center gap-3 border-2 border-green-500">
                        <span class="text-2xl">${state.toast.icon}</span>
                        <span class="text-sm font-semibold text-gray-800">${state.toast.message}</span>
                    </div>
                </div>
            `;
        }

        function renderModal() {
            if (!state.modal) return '';

            const isInput = state.modal.type === 'input';

            return `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-[60] p-4" onclick="event.target === this && closeModal()">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 modal-content" onclick="event.stopPropagation()">
                        <div class="text-center mb-2">
                            <div class="text-5xl mb-2">${state.modal.icon}</div>
                            ${isInput ? `
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${state.modal.title}</h3>
                                <input type="text" class="modal-input w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-mauve-400 focus:outline-none" placeholder="${state.modal.placeholder}" />
                            ` : `
                                <p class="text-base font-bold text-gray-800 whitespace-pre-line">${state.modal.message}</p>
                            `}
                        </div>
                        <div class="flex gap-2 justify-center">
                            ${state.modal.buttons.map(btn => {
                                const deleteContestMatch = btn.action.match(/confirmDeleteContest_(.+)/);
                                const banUserMatch = btn.action.match(/executeBanUser_(.+)/);
                                const removeImageMatch = btn.action.match(/confirmRemoveImage_(.+)/);
                                let onclick;
                                if (deleteContestMatch) {
                                    onclick = `confirmDeleteContest('${deleteContestMatch[1]}')`;
                                } else if (banUserMatch) {
                                    onclick = `executeBanUser('${banUserMatch[1]}')`;
                                } else if (removeImageMatch) {
                                    onclick = `confirmRemoveImage(${removeImageMatch[1]})`;
                                } else {
                                    onclick = `${btn.action}()`;
                                }
                                return `
                                    <button
                                        onclick="${onclick}"
                                        class="px-5 py-2 rounded-lg font-semibold transition text-sm ${
                                            btn.primary
                                                ? 'bg-gradient-to-r from-mauve-400 to-mauve-600 text-white hover:from-mauve-500 hover:to-mauve-700'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }"
                                    >
                                        ${btn.text}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const showBackButton = state.view === 'results' || state.view === 'vote';
            const isAdmin = state.user && state.user.id === ADMIN_DISCORD_ID;

            return `
                <header class="safe-header bg-gradient-to-r from-mauve-600 via-mauve-300 to-green-700 text-white shadow-lg">
                    <div class="max-w-7xl mx-auto px-3 py-2 sm:py-3 flex justify-between items-center gap-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-br from-mauve-300 to-mauve-500">
                                <span class="text-xl">ðŸŒº</span>
                            </div>
                            <h1 class="text-xl font-bold">Peony</h1>
                            ${showBackButton ? `
                                <button onclick="backToHome()" class="ml-2 bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 sm:py-1 rounded-lg font-semibold transition text-sm flex items-center gap-1 min-h-[36px] sm:min-h-0">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    Back
                                </button>
                            ` : ''}
                        </div>
                        
                        ${!state.isLoggedIn ? `
                            <button onclick="login()" class="bg-white text-mauve-500 px-4 py-2 rounded-lg font-semibold hover:bg-pink-50 transition text-sm min-h-[36px]">
                                Login with Discord
                            </button>
                        ` : `
                            <div class="flex items-center gap-2">
                                <div class="relative group">
                                    <div class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                                        <img src="${state.user.avatar}" alt="Avatar" class="w-7 h-7 rounded-full" />
                                        <span class="font-medium text-sm hidden sm:inline">${state.user.username}</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </div>
                                    <div class="hidden group-hover:block absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50">
                                        ${isAdmin ? `
                                            <button onclick="showAdminDashboard()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                âš™ï¸ Admin Dashboard
                                            </button>
                                        ` : ''}
                                        <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 ${isAdmin ? 'border-t border-gray-200' : ''}">
                                            Logout
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </header>
            `;
        }

        function renderLoginScreen() {
            return `
                <div class="max-w-md mx-auto mt-20 p-6 bg-white rounded-2xl shadow-xl fade-in">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-mauve-300 to-mauve-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-3xl">ðŸŒº</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome to Peony</h2>
                        <p class="text-gray-600 text-sm">Create and vote on image contests</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <p class="text-xs text-blue-800">
                            <strong>Privacy Notice:</strong> This app only accesses your Discord username and avatar. Contact me if you have any questions.
                        </p>
                    </div>
                    
                    <button onclick="login()" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-indigo-800 transition flex items-center justify-center gap-2 text-sm">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                        Login with Discord
                    </button>
                </div>
            `;
        }

        function setSortBy(sortBy) {
            state.filters.sortBy = sortBy;
            render();
        }

        function setFilterCreator(creatorId) {
            state.filters.createdBy = creatorId === 'all' ? null : creatorId;
            render();
        }

        function clearAllFilters() {
            state.filters.createdBy = null;
            state.filters.sortBy = 'newest';
            render();
        }

        function renderHome() {
            // Ensure all contests have results generated for voter count
            state.contests.forEach(contest => {
                if (!state.mockResultsCache[contest.id]) {
                    const userVotes = state.userVotedContests[contest.id] || {};
                    state.mockResultsCache[contest.id] = generateMockResults(contest, userVotes);
                }
            });

            // Get unique creators
            const creators = [...new Set(state.contests.map(c => ({ id: c.createdBy, name: c.creatorName })))];
            const uniqueCreators = Array.from(new Map(creators.map(c => [c.id, c])).values());

            // Get unique voters (users who have voted on contests)
            const voters = [];
            state.contests.forEach(contest => {
                const results = state.mockResultsCache[contest.id];
                if (results && results.voters) {
                    results.voters.forEach(voter => {
                        if (!voters.find(v => v.id === voter.id)) {
                            voters.push({ id: voter.id, name: voter.name });
                        }
                    });
                }
            });

            // Filter contests
            let filteredContests = state.contests;

            // Filter by creator
            if (state.filters.createdBy) {
                filteredContests = filteredContests.filter(c => c.createdBy === state.filters.createdBy);
            }

            // Sort contests
            filteredContests = [...filteredContests].sort((a, b) => {
                const voterCountA = getVoterCount(a);
                const voterCountB = getVoterCount(b);

                switch (state.filters.sortBy) {
                    case 'newest':
                    case 'dateDesc':
                        return (b.createdAt || 0) - (a.createdAt || 0);
                    case 'oldest':
                    case 'dateAsc':
                        return (a.createdAt || 0) - (b.createdAt || 0);
                    case 'titleAsc':
                        return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
                    case 'titleDesc':
                        return b.title.toLowerCase().localeCompare(a.title.toLowerCase());
                    case 'mostVoted':
                    case 'votersDesc':
                        return voterCountB - voterCountA;
                    case 'leastVoted':
                    case 'votersAsc':
                        return voterCountA - voterCountB;
                    case 'imagesDesc':
                        return b.images.length - a.images.length;
                    case 'imagesAsc':
                        return a.images.length - b.images.length;
                    default:
                        return 0;
                }
            });

            const isBanned = state.bannedUsers.includes(state.user.id);

            return `
                <div class="max-w-7xl mx-auto px-3 py-4">
                    <div class="flex justify-between items-center mb-4 gap-2 flex-wrap">
                        <h2 class="text-2xl font-bold text-gray-800">All Contests</h2>
                        ${isBanned ? `
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-lg text-sm">
                                ðŸš« Your account has been restricted. Contact admin.
                            </div>
                        ` : `
                            <button onclick="startCreateContest()" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-4 py-2 rounded-lg font-semibold hover:from-green-600 hover:to-green-800 transition shadow-lg text-sm">
                                + Create Contest
                            </button>
                        `}
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-3 mb-4 flex gap-3 flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs font-medium text-gray-700 mb-1 block">Sort By</label>
                            <select onchange="setSortBy(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-mauve-400 focus:outline-none">
                                <option value="newest" ${state.filters.sortBy === 'newest' || state.filters.sortBy === 'dateDesc' ? 'selected' : ''}>Newest First</option>
                                <option value="oldest" ${state.filters.sortBy === 'oldest' || state.filters.sortBy === 'dateAsc' ? 'selected' : ''}>Oldest First</option>
                                <option value="titleAsc" ${state.filters.sortBy === 'titleAsc' ? 'selected' : ''}>A-Z</option>
                                <option value="titleDesc" ${state.filters.sortBy === 'titleDesc' ? 'selected' : ''}>Z-A</option>
                                <option value="mostVoted" ${state.filters.sortBy === 'mostVoted' || state.filters.sortBy === 'votersDesc' ? 'selected' : ''}>Most Voters</option>
                                <option value="leastVoted" ${state.filters.sortBy === 'leastVoted' || state.filters.sortBy === 'votersAsc' ? 'selected' : ''}>Fewest Voters</option>
                                <option value="imagesDesc" ${state.filters.sortBy === 'imagesDesc' ? 'selected' : ''}>Most Images</option>
                                <option value="imagesAsc" ${state.filters.sortBy === 'imagesAsc' ? 'selected' : ''}>Fewest Images</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs font-medium text-gray-700 mb-1 block">Filter by Creator</label>
                            <select onchange="setFilterCreator(this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-mauve-400 focus:outline-none">
                                <option value="all" ${state.filters.createdBy === null ? 'selected' : ''}>All Creators</option>
                                ${uniqueCreators.map(creator => `
                                    <option value="${creator.id}" ${state.filters.createdBy === creator.id ? 'selected' : ''}>${creator.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        ${state.filters.createdBy || state.filters.sortBy !== 'newest' ? `
                            <div class="flex items-end">
                                <button onclick="clearAllFilters()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm">
                                    Clear All Filters
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    ${state.filters.createdBy ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex gap-2 items-center flex-wrap">
                            <span class="text-sm font-medium text-blue-800">Active Filters:</span>
                            <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-xs font-semibold flex items-center gap-1">
                                Creator: ${uniqueCreators.find(c => c.id === state.filters.createdBy)?.name || 'Unknown'}
                                <button onclick="setFilterCreator('all')" class="hover:text-blue-900">âœ•</button>
                            </span>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${filteredContests.map(contest => {
                            const hasVoted = state.userVotedContests[contest.id];
                            const voterCount = getVoterCount(contest);
                            const canDelete = canDeleteContest(contest);
                            const createdDate = contest.createdAt ? new Date(contest.createdAt).toLocaleString() : '';

                            return `
                                <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition fade-in p-4 relative">
                                    ${contest.createdBy === state.user.id ? `
                                        <button
                                            onclick='toggleContestLock("${contest.id}")'
                                            class="absolute top-3 right-3 p-1.5 rounded-full shadow-lg transition-all hover:scale-110 ${contest.isLocked ? 'bg-black hover:bg-gray-900' : 'bg-green-500 hover:bg-green-600'}"
                                            title="${contest.isLocked ? 'Click to unlock contest' : 'Click to lock contest'}"
                                        >
                                            ${contest.isLocked ? `
                                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                                </svg>
                                            ` : `
                                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                                                </svg>
                                            `}
                                        </button>
                                    ` : contest.isLocked ? `
                                        <div class="absolute top-3 right-3 bg-black text-white p-1.5 rounded-full shadow-lg" title="Contest is locked">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                            </svg>
                                        </div>
                                    ` : ''}
                                    <div class="flex items-start gap-2 mb-2">
                                        <img src="${contest.creatorAvatar}" alt="${contest.creatorName}" class="w-8 h-8 rounded-full flex-shrink-0" />
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <h3 class="text-base font-bold text-gray-800 truncate">${contest.title}</h3>
                                            </div>
                                            <div class="text-xs text-gray-500 flex items-center gap-2 flex-wrap">
                                                <span class="truncate">by ${contest.creatorName}</span>
                                                ${createdDate ? `<span class="whitespace-nowrap">ðŸ“… ${createdDate}</span>` : ''}
                                                <span class="ml-auto whitespace-nowrap">${voterCount}ðŸ‘¥ ${contest.images.length}ðŸ–¼ï¸</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex gap-2">
                                        ${contest.isLocked ? `
                                            <button
                                                onclick='viewLockedResults(${JSON.stringify(contest).replace(/'/g, "&apos;")})'
                                                class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-2 rounded-lg font-semibold hover:from-gray-600 hover:to-gray-700 transition shadow-md text-sm"
                                            >
                                                View Results
                                            </button>
                                        ` : hasVoted ? `
                                            <button
                                                onclick='viewResults(${JSON.stringify(contest).replace(/'/g, "&apos;")})'
                                                class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 transition shadow-md text-sm"
                                            >
                                                View Results
                                            </button>
                                        ` : isBanned ? `
                                            <div class="flex-1 bg-red-100 border border-red-400 text-red-700 py-2 rounded-lg text-center text-xs">
                                                ðŸš« Account restricted
                                            </div>
                                        ` : `
                                            <button
                                                onclick='startVoting(${JSON.stringify(contest).replace(/'/g, "&apos;")})'
                                                class="flex-1 bg-gradient-to-r from-mauve-400 to-mauve-600 text-white py-2 rounded-lg font-semibold hover:from-mauve-500 hover:to-mauve-700 transition shadow-md text-sm"
                                            >
                                                Start Voting
                                            </button>
                                        `}
                                        ${canDelete ? `
                                            <button 
                                                onclick="deleteContest('${contest.id}')"
                                                class="bg-red-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm"
                                                title="Delete Contest"
                                            >
                                                ðŸ—‘ï¸
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCreateContest() {
            return `
                <div class="max-w-5xl mx-auto px-3 py-4">
                    <div class="bg-white rounded-xl shadow-xl p-4 fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${state.newContest.title}</h2>
                            </div>
                            <button onclick="cancelCreateContest()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1 text-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Cancel
                            </button>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2 text-sm">
                                <span class="text-xl">ðŸ“¸</span>
                                How to Add Images
                            </h3>
                            <p class="text-xs text-blue-800 mb-1">
                                ðŸ’» <strong>Desktop:</strong> Click image â†’ Right-click â†’ Copy image link â†’ Paste below
                            </p>
                            <p class="text-xs text-blue-800">
                                ðŸ“± <strong>Mobile:</strong> Open image â†’ Share â†’ Copy link â†’ Paste below
                            </p>
                        </div>

                        <div class="mb-4">
                            <input type="url" id="contestUrlInput" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-sm mb-2" placeholder="Paste Discord image URL or any image URL...">
                            <button onclick="addImageFromUrl('contestUrlInput')" class="w-full bg-gradient-to-r from-mauve-400 to-mauve-600 text-white py-2 rounded-lg font-semibold hover:from-mauve-500 hover:to-mauve-700 transition text-sm">
                                Add URL
                            </button>
                        </div>

                        <div class="flex items-center justify-between mb-3 p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm font-semibold text-gray-800">
                                ${state.newContest.images.length} / 50 images added
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" ${state.newContest.labelsEnabled ? 'checked' : ''} onchange="toggleImageLabels()" class="w-4 h-4 text-mauve-500 rounded focus:ring-mauve-400">
                                <span class="text-sm font-medium text-gray-700">Enable Image Labels</span>
                            </label>
                        </div>

                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 mb-4 min-h-[100px]">
                            ${state.newContest.images.length === 0 ? `
                                <div class="col-span-full text-center text-gray-400 py-8 text-sm italic">
                                    No images added yet
                                </div>
                            ` : state.newContest.images.map((img, index) => `
                                <div class="relative group bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center" style="min-height: 100px;">
                                    <img src="${img.url}" class="w-full h-auto max-h-24 object-contain" />
                                    <button onclick="removeContestImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-lg">
                                        Ã—
                                    </button>
                                    ${state.newContest.labelsEnabled ? `
                                        <div class="p-2 bg-white">
                                            <input
                                                type="text"
                                                value="${img.label || ''}"
                                                onchange="updateImageLabel(${index}, this.value)"
                                                maxlength="50"
                                                placeholder="Image label..."
                                                class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:border-mauve-400 focus:outline-none"
                                            />
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>

                        <button 
                            onclick="finishCreateContest()" 
                            ${state.newContest.images.length === 0 ? 'disabled' : ''}
                            class="w-full bg-gradient-to-r from-green-500 to-green-700 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-green-800 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                        >
                            Create Contest (${state.newContest.images.length} images)
                        </button>
                    </div>
                </div>
            `;
        }

        function renderVoting() {
            const currentImage = state.shuffledImages[state.currentImageIndex];
            const currentVote = state.votes[currentImage.id];
            const allVoted = state.shuffledImages.every(img => state.votes[img.id]);

            // Adaptive progress bar logic - ensure EXACTLY segmentCount dashes
            const imageCount = state.shuffledImages.length;
            const segmentCount = Math.min(imageCount, 20);
            const imagesPerSegment = Math.ceil(imageCount / segmentCount);

            return `
                <div class="max-w-4xl mx-auto px-3 py-4">
                    <div class="bg-white rounded-xl shadow-xl overflow-hidden fade-in">
                        <div class="bg-gray-200 h-3 flex gap-1 p-1">
                            ${Array.from({ length: segmentCount }, (_, segmentIdx) => {
                                const startIdx = segmentIdx * imagesPerSegment;
                                const endIdx = Math.min(startIdx + imagesPerSegment, imageCount);

                                // Skip segments that would start beyond our image count
                                if (startIdx >= imageCount) return '';

                                const segmentImages = state.shuffledImages.slice(startIdx, endIdx);

                                const votedCount = segmentImages.filter(img => state.votes[img.id]).length;
                                const totalCount = segmentImages.length;
                                const hasCurrentImage = state.currentImageIndex >= startIdx && state.currentImageIndex < endIdx;

                                // Determine color based on priority
                                let bgColor;
                                if (hasCurrentImage) {
                                    bgColor = 'bg-mauve-400';
                                } else if (votedCount === totalCount) {
                                    bgColor = 'bg-green-500';
                                } else if (votedCount > 0) {
                                    bgColor = 'bg-yellow-500';
                                } else {
                                    bgColor = 'bg-gray-300';
                                }

                                const imageRange = startIdx + 1 === endIdx ? `Image ${startIdx + 1}` : `Images ${startIdx + 1}-${endIdx}`;
                                const tooltip = `${imageRange} (${votedCount}/${totalCount} voted)`;

                                return `
                                    <div
                                        onclick="jumpToImage(${startIdx})"
                                        class="progress-segment flex-1 ${bgColor}"
                                        title="${tooltip}"
                                    ></div>
                                `;
                            }).join('')}
                        </div>

                        <div class="p-3">
                            <div class="flex justify-between items-center mb-3 gap-2">
                                <h2 class="text-lg font-bold text-gray-800">${state.currentContest.title}</h2>
                                <span class="text-gray-600 font-medium text-sm">${state.currentImageIndex + 1}/${state.shuffledImages.length}</span>
                            </div>

                            ${(() => {
                                const isMobile = typeof window !== 'undefined' && window.innerWidth < 768;
                                const imageContainerHeight = isMobile ? '50vh' : '60vh';
                                const maxImageHeight = isMobile ? 'none' : '600px';

                                return `
                                    <div class="relative mb-3 bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center" style="height: ${imageContainerHeight};">
                                        ${state.currentContest.labelsEnabled && currentImage.label ? `
                                            <div class="absolute top-0 left-0 right-0 bg-white px-4 py-2 text-center border-b border-gray-200 z-10">
                                                <span class="text-sm font-semibold text-gray-800">${currentImage.label}</span>
                                            </div>
                                        ` : ''}
                                        <img
                                            src="${currentImage.url}"
                                            alt="Image ${state.currentImageIndex + 1}"
                                            class="max-h-full max-w-full object-contain"
                                            style="${maxImageHeight !== 'none' ? `max-height: ${maxImageHeight};` : ''}"
                                            onload="this.parentElement.classList.remove('image-loading')"
                                        />
                                        ${currentVote ? `
                                            <div class="absolute top-2 right-2 bg-white rounded-full px-3 py-1 shadow-lg flex items-center gap-1 text-sm">
                                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                <span class="font-semibold">Voted: ${currentVote}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            })()}

                            <div class="flex justify-center gap-2 mb-3">
                                ${[1, 2, 3, 4, 5].map(score => `
                                    <button 
                                        data-score="${score}"
                                        onclick="handleVote(${score})" 
                                        ${state.isAnimating ? 'disabled' : ''}
                                        class="w-12 h-12 sm:w-14 sm:h-14 rounded-full font-bold text-white text-base shadow-lg hover:scale-110 transition-transform relative ${currentVote === score ? 'ring-4 ring-offset-2' : ''} ${state.isAnimating ? 'opacity-70 cursor-not-allowed' : ''}"
                                        style="background-color: ${getScoreColor(score)}; transform: ${currentVote === score ? 'scale(1.15)' : 'scale(1)'}; ring-color: ${getScoreColor(score)};"
                                    >
                                        ${score}
                                        ${currentVote === score && state.showTickAnimation ? `
                                            <svg class="absolute -top-1 -right-1 w-6 h-6 text-white bg-green-600 rounded-full p-1 tick-animation" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        ` : currentVote === score ? `
                                            <svg class="absolute -top-1 -right-1 w-6 h-6 text-white bg-green-600 rounded-full p-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        ` : ''}
                                    </button>
                                `).join('')}
                            </div>

                            <div class="flex justify-between items-center gap-2">
                                <button 
                                    onclick="navigateImage('prev')" 
                                    ${state.currentImageIndex === 0 ? 'disabled' : ''}
                                    class="flex items-center gap-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-semibold hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                                >
                                    â† Prev
                                </button>

                                ${allVoted ? `
                                    <button onclick="submitVotes()" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-4 py-2 rounded-lg font-semibold hover:from-green-600 hover:to-green-800 transition flex items-center gap-1 shadow-lg text-sm">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Submit
                                    </button>
                                ` : '<div></div>'}

                                <button 
                                    onclick="navigateImage('next')" 
                                    class="flex items-center gap-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-semibold hover:bg-gray-300 transition text-sm"
                                >
                                    Next â†’
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResults() {
            if (!state.mockResults) {
                state.mockResults = generateMockResults(state.currentContest, state.votes);
            }

            let displayResults, grouped, sortedKeys, voterStats;

            // === BY VOTER VIEW ===
            // Shows statistics for each voter, including their average score across all images
            if (state.resultsView === 'byVoter') {
                if (state.joinedContests.length > 0) {
                    // Merged contests: Aggregate voter stats across all joined contests
                    const allContests = [state.currentContest, ...state.joinedContests.map(id => state.contests.find(c => c.id === id)).filter(Boolean)];
                    voterStats = generateVoterStats(allContests);
                } else {
                    // Single contest view
                    voterStats = generateVoterStats(state.currentContest);
                }
            }
            // === MY VOTES VIEW ===
            // Shows images grouped by the current user's vote scores
            else if (state.resultsView === 'myVotes' && Object.keys(state.votes).length > 0) {
                if (state.joinedContests.length > 0) {
                    // For merged contests, combine votes from all contests
                    const allContests = [state.currentContest, ...state.joinedContests.map(id => state.contests.find(c => c.id === id)).filter(Boolean)];
                    const contestNumberMap = {};
                    allContests.forEach((contest, index) => {
                        contestNumberMap[contest.id] = index + 1;
                    });

                    // Get votes from current contest
                    const currentVotes = state.currentContest.images.map(img => ({
                        ...img,
                        averageScore: state.votes[img.id] || 0,
                        totalVotes: 1,
                        contestId: state.currentContest.id,
                        contestTitle: state.currentContest.title,
                        contestNumber: contestNumberMap[state.currentContest.id],
                        breakdown: [{
                            username: state.user.username,
                            avatar: state.user.avatar,
                            score: state.votes[img.id] || 0,
                            isCurrentUser: true
                        }]
                    }));

                    // Get votes from joined contests
                    const joinedVotes = state.joinedContests.flatMap(contestId => {
                        const contest = state.contests.find(c => c.id === contestId);
                        if (!contest) return [];
                        const userVotes = state.userVotedContests[contestId] || {};
                        return contest.images.map(img => ({
                            ...img,
                            averageScore: userVotes[img.id] || 0,
                            totalVotes: 1,
                            contestId: contest.id,
                            contestTitle: contest.title,
                            contestNumber: contestNumberMap[contest.id],
                            breakdown: [{
                                username: state.user.username,
                                avatar: state.user.avatar,
                                score: userVotes[img.id] || 0,
                                isCurrentUser: true
                            }]
                        }));
                    });

                    displayResults = [...currentVotes, ...joinedVotes].sort((a, b) => b.averageScore - a.averageScore);
                } else {
                    // Single contest view
                    displayResults = state.currentContest.images.map(img => ({
                        ...img,
                        averageScore: state.votes[img.id] || 0,
                        totalVotes: 1,
                        breakdown: [{
                            username: state.user.username,
                            avatar: state.user.avatar,
                            score: state.votes[img.id] || 0,
                            isCurrentUser: true
                        }]
                    })).sort((a, b) => b.averageScore - a.averageScore);
                }

                grouped = groupMyVotesByScore(displayResults);
                sortedKeys = Object.keys(grouped).sort((a, b) => parseInt(b) - parseInt(a));
            }
            // === AVERAGE VIEW ===
            // Shows images grouped by average score ranges (e.g., 4.5-5.0, 4.0-4.49, etc.)
            else {
                displayResults = state.mockResults;
                grouped = groupByScoreRange(displayResults);
                sortedKeys = Object.keys(grouped).sort((a, b) => {
                    const aMin = grouped[a].min;
                    const bMin = grouped[b].min;
                    return bMin - aMin;
                });
            }
            
            const baseSize = 150;
            const imageSize = Math.max(30, Math.min(500, Math.floor(baseSize * (state.imageScale / 100))));
            const baseFontSize = 12;
            const fontSize = Math.floor(baseFontSize * (state.imageScale / 100));

            return `
                <div class="max-w-7xl mx-auto px-3 py-4">
                    <div class="bg-white rounded-xl shadow-xl p-4 fade-in results-bg">
                        <div class="text-center mb-4">
                            <div class="flex items-center justify-center gap-2 mb-2">
                                <span class="text-4xl">ðŸŽ†</span>
                                <h2 class="text-2xl font-bold text-gray-800">Final Ranking</h2>
                            </div>
                            <p class="text-gray-600 text-sm mb-1">${
                                state.resultsView === 'byVoter' ? 'Voter statistics and average scores' :
                                state.resultsView === 'myVotes' ? 'Your votes only' :
                                'Average votes from all participants'
                            }</p>
                            ${state.joinedContests.length > 0 ? `
                                <p class="text-xs text-purple-600 font-semibold mb-2">ðŸ”— Viewing ${state.joinedContests.length + 1} merged contests</p>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-2 max-w-2xl mx-auto">
                                    <p class="text-xs font-semibold text-purple-800 mb-2">Contest Legend:</p>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 text-xs">
                                        ${state.mergedContestMap.map(contest => `
                                            <div class="flex items-center gap-2">
                                                <span class="bg-purple-600 text-white px-2 py-0.5 rounded font-bold min-w-[24px] text-center">#${contest.number}</span>
                                                <span class="text-gray-700 truncate">${contest.title}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <p class="text-xs text-gray-500">Click on any image to see the vote breakdown</p>

                            <div class="mt-3 flex flex-col items-center justify-center gap-2">
                                <!-- First row: View tabs -->
                                <div class="flex items-center justify-center gap-3">
                                    <button
                                        onclick="setResultsView('average')"
                                        class="px-3 py-1 rounded-lg ${state.resultsView === 'average' ? 'bg-mauve-400 text-white' : 'bg-gray-200'}"
                                    >
                                        Average
                                    </button>
                                    <button
                                        onclick="setResultsView('myVotes')"
                                        class="px-3 py-1 rounded-lg ${state.resultsView === 'myVotes' ? 'bg-mauve-400 text-white' : 'bg-gray-200'}"
                                    >
                                        My Votes
                                    </button>
                                    <button
                                        onclick="setResultsView('byVoter')"
                                        class="px-3 py-1 rounded-lg ${state.resultsView === 'byVoter' ? 'bg-mauve-400 text-white' : 'bg-gray-200'}"
                                    >
                                        By Voter
                                    </button>
                                </div>
                                <!-- Second row: Action button (Join Contest or Unmerge) -->
                                <div class="flex items-center justify-center">
                                    ${state.joinedContests.length > 0 ? `
                                        <button
                                            onclick="clearJoinedContests()"
                                            class="px-3 py-1 rounded-lg bg-gray-500 text-white hover:bg-gray-600 transition text-sm"
                                            title="Return to single contest view"
                                        >
                                            â† Unmerge
                                        </button>
                                    ` : `
                                        <button
                                            onclick="showJoinContests()"
                                            class="px-3 py-1 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition text-sm"
                                            title="Merge results with another contest"
                                        >
                                            ðŸ”— Join Contest
                                        </button>
                                    `}
                                </div>
                            </div>
                        </div>

                        ${state.resultsView !== 'byVoter' ? `
                        <div class="mb-4 max-w-md mx-auto">
                            <div class="flex items-center gap-2">
                                <label class="text-xs font-medium text-gray-700 whitespace-nowrap">Image Scale:</label>
                                <button
                                    onclick="adjustScale(-1)"
                                    class="w-6 h-6 rounded bg-gray-200 hover:bg-gray-300 flex items-center justify-center font-bold text-gray-700 transition"
                                    title="Decrease scale"
                                >âˆ’</button>
                                <input
                                    type="range"
                                    id="scaleSlider"
                                    min="40"
                                    max="200"
                                    value="${state.imageScale}"
                                    oninput="updateScale(this.value)"
                                    class="flex-1 h-2 bg-gray-200 rounded-lg cursor-pointer"
                                />
                                <button
                                    onclick="adjustScale(1)"
                                    class="w-6 h-6 rounded bg-gray-200 hover:bg-gray-300 flex items-center justify-center font-bold text-gray-700 transition"
                                    title="Increase scale"
                                >+</button>
                                <span class="text-xs font-medium text-gray-700 w-10">${state.imageScale}%</span>
                            </div>
                        </div>
                        ` : ''}

                        ${state.resultsView === 'byVoter' ? `
                            ${voterStats && voterStats.length > 0 ? `
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2">
                                    ${voterStats.map(voter => `
                                        <div class="bg-white rounded-lg shadow-md p-3 flex flex-col items-center hover:shadow-lg transition-shadow cursor-pointer border-2 ${voter.isCurrentUser ? 'border-mauve-400' : 'border-transparent'}">
                                            <img src="${voter.avatar}" alt="${voter.username}" class="w-12 h-12 rounded-full mb-2" />
                                            <div class="text-xs font-semibold text-gray-800 truncate w-full text-center mb-1" title="${voter.username}">
                                                ${voter.username}
                                            </div>
                                            <div class="text-xl font-bold text-white score-text">
                                                ${voter.averageScore}
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${voter.totalImages} vote${voter.totalImages !== 1 ? 's' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <div class="text-6xl mb-4">ðŸ‘¥</div>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">No Voters Yet</h3>
                                    <p class="text-gray-600">No voting data available for this contest.</p>
                                </div>
                            `}
                        ` : state.resultsView === 'myVotes' && Object.keys(state.votes).length === 0 ? `
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">ðŸ“­</div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">No Votes Yet</h3>
                                <p class="text-gray-600">You haven't voted on this contest yet.</p>
                            </div>
                        ` : sortedKeys.map(key => {
                            const group = grouped[key];

                            if (state.resultsView === 'myVotes') {
                                const score = group.score;
                                const colorStyle = getScoreColor(score);
                                return `
                                    <div class="mb-4">
                                        <h3 class="text-sm font-bold mb-1 px-3 py-1 rounded-lg inline-block" style="color: white; background-color: ${colorStyle};">
                                            Score ${score}
                                        </h3>
                                        <div class="flex flex-wrap gap-1">
                                            ${group.items.map(item => `
                                                <div
                                                    onclick="showBreakdown(${item.id})"
                                                    class="cursor-pointer hover:scale-105 transition-transform rounded-lg overflow-hidden shadow-lg relative"
                                                    style="height: ${imageSize}px;"
                                                >
                                                    <img
                                                        src="${item.url}"
                                                        alt="Image"
                                                        class="h-full w-auto object-cover"
                                                        style="height: ${imageSize}px;"
                                                        onload="this.parentElement.classList.remove('image-loading')"
                                                    />
                                                    ${state.joinedContests.length > 0 && item.contestNumber ? `
                                                        <div class="absolute top-0 left-0 bg-purple-600 text-white text-center font-bold px-2 py-0.5 rounded-br" style="font-size: ${Math.max(10, fontSize)}px;">
                                                            #${item.contestNumber}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            } else {
                                const colorStyle = getCategoryColor(group.min);
                                return `
                                    <div class="mb-4">
                                        <h3 class="text-sm font-bold mb-1 px-3 py-1 rounded-lg ${colorStyle.color} ${colorStyle.bg} w-full block">
                                            ${getCategoryLabel(group.min, group.max)}
                                        </h3>
                                        <div class="flex flex-wrap gap-1">
                                            ${group.items.map(item => `
                                                <div
                                                    onclick="showBreakdown(${item.id})"
                                                    class="cursor-pointer hover:scale-105 transition-transform rounded-lg overflow-hidden shadow-lg relative"
                                                    style="height: ${imageSize}px;"
                                                >
                                                    <img
                                                        src="${item.url}"
                                                        alt="Image"
                                                        class="h-full w-auto object-cover"
                                                        style="height: ${imageSize}px;"
                                                        onload="this.parentElement.classList.remove('image-loading')"
                                                    />
                                                    ${state.joinedContests.length > 0 && item.contestNumber ? `
                                                        <div class="absolute top-0 left-0 bg-purple-600 text-white text-center font-bold px-2 py-0.5 rounded-br" style="font-size: ${Math.max(10, fontSize)}px;">
                                                            #${item.contestNumber}
                                                        </div>
                                                    ` : ''}
                                                    <div class="absolute bottom-0 left-0 right-0 text-white text-center py-1 font-bold score-text" style="font-size: ${fontSize}px;">
                                                        ${item.averageScore}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>

                    ${state.showBreakdownModal ? renderBreakdownModal() : ''}
                </div>
            `;
        }

        function renderBreakdownModal() {
            const item = state.mockResults.find(r => r.id === state.showBreakdownModal);
            if (!item) return '';

            const votesByScore = { 1: [], 2: [], 3: [], 4: [], 5: [] };
            item.breakdown.forEach(vote => {
                votesByScore[vote.score].push(vote);
            });

            Object.keys(votesByScore).forEach(score => {
                votesByScore[score].sort((a, b) => a.username.localeCompare(b.username));
            });

            return `
                <div class="fixed inset-0 modal-overlay flex items-start sm:items-center justify-center z-50 p-4 overflow-y-auto" onclick="event.target === this && closeBreakdown()">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] sm:max-h-[85vh] flex flex-col modal-content my-4 sm:my-0" onclick="event.stopPropagation()">
                        <div class="p-4 flex-shrink-0 bg-white z-10 border-b border-gray-200 rounded-t-2xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-gray-800">Vote Breakdown</h3>
                                <button onclick="closeBreakdown()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="overflow-y-auto flex-1 p-4">

                            <div class="mb-3 rounded-lg overflow-hidden flex items-center justify-center bg-gray-100" style="max-height: 400px;">
                                <img
                                    src="${item.url}"
                                    alt="Image"
                                    class="max-w-full max-h-[400px] object-contain"
                                    onload="this.parentElement.classList.remove('image-loading')"
                                />
                            </div>

                            <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-gray-800">${item.averageScore}</div>
                                    <div class="text-xs text-gray-600">Average Score</div>
                                    <div class="text-xs text-gray-500 mt-1">${item.totalVotes} total votes</div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                ${[5, 4, 3, 2, 1].map(score => `
                                    <div>
                                        <h4 class="text-sm font-bold mb-2 px-3 py-1 rounded-lg inline-block" style="color: ${getScoreColor(score)}; background-color: ${getScoreColor(score)}20;">
                                            Score ${score} (${votesByScore[score].length} ${votesByScore[score].length === 1 ? 'vote' : 'votes'})
                                        </h4>
                                        ${votesByScore[score].length > 0 ? `
                                            <div class="grid grid-cols-2 gap-2 mt-2">
                                                ${votesByScore[score].map(vote => `
                                                    <div class="flex items-center gap-2 p-2 rounded-lg ${
                                                        vote.isBanned ? 'bg-gray-200 opacity-50' :
                                                        vote.isCurrentUser ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'
                                                    }">
                                                        <img src="${vote.avatar}" alt="${vote.username}" class="w-8 h-8 rounded-full flex-shrink-0" />
                                                        <span class="text-sm text-gray-700 truncate ${vote.isBanned ? 'opacity-50 line-through' : ''}">
                                                            ${vote.username}${vote.isCurrentUser ? ' (You)' : ''}
                                                        </span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div class="text-gray-400 italic text-sm mt-2 ml-3">No votes</div>
                                        `}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminDashboard() {
            if (!state.showAdminDashboard) return '';

            const isAdmin = state.user && state.user.id === ADMIN_DISCORD_ID;
            if (!isAdmin) return '';

            // Get banned users info
            const bannedUsersInfo = state.bannedUsers.map(userId => {
                // Try to find user info from contests
                const contest = state.contests.find(c => c.createdBy === userId);
                if (contest) {
                    return {
                        id: userId,
                        username: contest.creatorName,
                        avatar: contest.creatorAvatar
                    };
                }
                // Try to find from votes
                for (const contestId in state.mockResultsCache) {
                    const results = state.mockResultsCache[contestId];
                    if (results && results.voters) {
                        const voter = results.voters.find(v => v.id === userId);
                        if (voter) {
                            return {
                                id: userId,
                                username: voter.name,
                                avatar: voter.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}`
                            };
                        }
                    }
                }
                // Fallback
                return {
                    id: userId,
                    username: 'User' + userId.substring(0, 4),
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}`
                };
            });

            // Calculate admin statistics
            const totalContests = state.contests.length;
            const totalVotes = Object.values(state.mockResultsCache).reduce((sum, results) => {
                return sum + (results.voters ? results.voters.length : 0);
            }, 0);
            const uniqueVoters = new Set();
            Object.values(state.mockResultsCache).forEach(results => {
                if (results.voters) {
                    results.voters.forEach(voter => uniqueVoters.add(voter.id));
                }
            });
            const totalUniqueVoters = uniqueVoters.size;
            const totalBannedUsers = state.bannedUsers.length;

            return `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4" onclick="event.target === this && closeAdminDashboard()">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-2xl font-bold text-gray-800">Admin Dashboard</h3>
                                <button onclick="closeAdminDashboard()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-200">
                                    <h4 class="font-bold text-gray-800 mb-3">Statistics</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <div class="bg-white rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-purple-600">${totalContests}</div>
                                            <div class="text-xs text-gray-600">Total Contests</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-blue-600">${totalVotes}</div>
                                            <div class="text-xs text-gray-600">Total Votes</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-green-600">${totalUniqueVoters}</div>
                                            <div class="text-xs text-gray-600">Unique Voters</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-red-600">${totalBannedUsers}</div>
                                            <div class="text-xs text-gray-600">Banned Users</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <h4 class="font-bold text-blue-800 mb-3">ðŸ‘¥ All Users</h4>
                                    ${state.allUsers.length > 0 ? `
                                        <div class="space-y-2 max-h-96 overflow-y-auto">
                                            ${[...state.allUsers].sort((a, b) => a.username.localeCompare(b.username)).map(user => {
                                                const isBanned = state.bannedUsers.includes(user.id);
                                                return `
                                                    <div class="flex items-center justify-between p-3 bg-white rounded-lg ${isBanned ? 'opacity-50' : ''}">
                                                        <div class="flex items-center gap-3">
                                                            <img src="${user.avatar}" alt="${user.username}" class="w-10 h-10 rounded-full" />
                                                            <div>
                                                                <div class="font-semibold text-gray-800">${user.username}</div>
                                                                <div class="text-xs text-gray-500">${user.id}</div>
                                                                ${isBanned ? '<span class="text-xs text-red-600 font-semibold">BANNED</span>' : ''}
                                                            </div>
                                                        </div>
                                                        ${isBanned ? `
                                                            <button onclick="unbanUser('${user.id}')" class="bg-green-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-green-600 transition text-sm">
                                                                Unban
                                                            </button>
                                                        ` : `
                                                            <button onclick="confirmBanUser('${user.id}')" class="bg-red-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-red-600 transition text-sm">
                                                                Ban
                                                            </button>
                                                        `}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : '<p class="text-sm text-gray-500 italic">No users have logged in yet</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function renderJoinContestsModal() {
            if (!state.showJoinModal) return '';

            // Filter out the current contest from available contests
            const availableContests = state.contests.filter(c => c.id !== state.currentContest?.id);

            return `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4" onclick="event.target === this && closeJoinContests()">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-2xl font-bold text-gray-800">ðŸ”— Join Contests</h3>
                                <button onclick="closeJoinContests()" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>

                            <p class="text-sm text-gray-600 mb-4">Select contests to merge with <strong>${state.currentContest?.title}</strong>. The results will be combined.</p>

                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-200 mb-4">
                                <h4 class="font-bold text-gray-800 mb-3">Available Contests</h4>
                                ${availableContests.length > 0 ? `
                                    <div class="space-y-2">
                                        ${availableContests.map(contest => {
                                            const isSelected = state.joinedContests.includes(contest.id);
                                            return `
                                                <div
                                                    class="flex items-center justify-between p-3 bg-white rounded-lg cursor-pointer hover:bg-gray-50 transition ${isSelected ? 'ring-2 ring-purple-500' : ''}"
                                                    onclick="toggleJoinContest('${contest.id}')"
                                                >
                                                    <div class="flex items-center gap-3">
                                                        <input
                                                            type="checkbox"
                                                            ${isSelected ? 'checked' : ''}
                                                            class="w-5 h-5 text-purple-500 rounded"
                                                            onclick="event.stopPropagation(); toggleJoinContest('${contest.id}')"
                                                        />
                                                        <div>
                                                            <div class="font-semibold text-gray-800">${contest.title}</div>
                                                            <div class="text-xs text-gray-500">
                                                                ${contest.images.length} images Â· by ${contest.creatorName}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 italic">No other contests available</p>'}
                            </div>

                            <div class="flex gap-3 justify-end">
                                <button
                                    onclick="closeJoinContests()"
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onclick="applyJoinedContests()"
                                    class="px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition"
                                    ${state.joinedContests.length === 0 ? 'disabled' : ''}
                                >
                                    Merge ${state.joinedContests.length > 0 ? `(${state.joinedContests.length})` : ''}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.isLoggedIn) {
                app.innerHTML = renderHeader() + renderLoginScreen() + renderModal() + renderToast();
                return;
            }

            let content = '';
            switch(state.view) {
                case 'home':
                    content = renderHome();
                    break;
                case 'createContest':
                    content = renderCreateContest();
                    break;
                case 'vote':
                    content = renderVoting();
                    break;
                case 'results':
                    content = renderResults();
                    break;
                default:
                    content = renderHome();
            }

            app.innerHTML = renderHeader() + content + renderModal() + (state.showAdminDashboard ? renderAdminDashboard() : '') + (state.showJoinModal ? renderJoinContestsModal() : '') + renderToast();
        }

        window.login = login;
        window.logout = logout;
        window.startCreateContest = startCreateContest;
        window.handleContestTitle = handleContestTitle;
        window.confirmCreateWithDuplicateTitle = confirmCreateWithDuplicateTitle;
        window.cancelCreateContest = cancelCreateContest;
        window.confirmCancelCreate = confirmCancelCreate;
        window.addImageFromUrl = addImageFromUrl;
        window.removeContestImage = removeContestImage;
        window.confirmRemoveImage = confirmRemoveImage;
        window.finishCreateContest = finishCreateContest;
        window.startVoting = startVoting;
        window.viewResults = viewResults;
        window.viewLockedResults = viewLockedResults;
        window.toggleContestLock = toggleContestLock;
        window.handleVote = handleVote;
        window.navigateImage = navigateImage;
        window.jumpToImage = jumpToImage;
        window.cancelVoting = cancelVoting;
        window.submitVotes = submitVotes;
        window.showBreakdown = showBreakdown;
        window.closeBreakdown = closeBreakdown;
        window.backToHome = backToHome;
        window.confirmBackToHome = confirmBackToHome;
        window.closeModal = closeModal;
        window.updateScale = updateScale;
        window.adjustScale = adjustScale;
        window.confirmSubmitVotes = confirmSubmitVotes;
        window.confirmCancelVoting = confirmCancelVoting;
        window.toggleVoteView = toggleVoteView;
        window.deleteContest = deleteContest;
        window.confirmDeleteContest = confirmDeleteContest;
        window.setSortBy = setSortBy;
        window.setFilterCreator = setFilterCreator;
        window.clearAllFilters = clearAllFilters;
        window.toggleImageLabels = toggleImageLabels;
        window.updateImageLabel = updateImageLabel;
        window.showAdminDashboard = showAdminDashboard;
        window.closeAdminDashboard = closeAdminDashboard;
        window.showJoinContests = showJoinContests;
        window.closeJoinContests = closeJoinContests;
        window.toggleJoinContest = toggleJoinContest;
        window.applyJoinedContests = applyJoinedContests;
        window.confirmBanUser = confirmBanUser;
        window.executeBanUser = executeBanUser;
        window.unbanUser = unbanUser;

        render();
    </script>
</body>
</html>
